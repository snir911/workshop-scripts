apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  name: 99-worker-crio-download
  labels:
    machineconfiguration.openshift.io/role: kata-oc
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
        - path: /usr/local/bin/crio-setup.sh
          mode: 0755
          contents:
            source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKc2V0IC1ldW8gcGlwZWZhaWwKCiMgZm9yIG9jcCAxLjE2LjMwOiBwb2RtYW4gcHVsbCByZWdpc3RyeS5hY2Nlc3MucmVkaGF0LmNvbS91Ymk5L2dvLXRvb2xzZXQ6MS4yMS4xMwoKZXhwb3J0IEtVQkVDT05GSUc9L2V0Yy9rdWJlcm5ldGVzL2t1YmVjb25maWcKI29jcHZlcnNpb249NC4xNi4zMAprOHN2ZXJzaW9uPSIkKG9jIHZlcnNpb24gLW8ganNvbiB8IGpxIC1yICcuc2VydmVyVmVyc2lvbiB8ICJcKC5tYWpvcikuXCgubWlub3IpIicpIgojIC91c3IvYmluL2NyaW8gLS12ZXJzaW9uIHwgZ3JlcCAiR29WZXJzaW9uOiIgfCBzZWQgLUUgJ3MvLipnbyhbMC05Ll0rKS4qL1wxLycKCmdvdmVyc2lvbj0kKG9jIHZlcnNpb24gLW8ganNvbiB8IGpxIC1yICcuc2VydmVyVmVyc2lvbi5nb1ZlcnNpb24gfCBjYXB0dXJlKCJnbyg/PHZlcj5bMC05Ll0rKSIpIHwgLnZlcicpCklOU1RBTExfQ09NTUFORD0iZG5mIGluc3RhbGwgLXkgbWFrZSB3Z2V0IGdjYyBnY2MtYysrIG9wZW5zc2wgb3BlbnNzbC1kZXZlbCBnaXQgZ3BnbWUtZGV2ZWwgbGlic2VjY29tcC1kZXZlbCBnbGliYy1zdGF0aWMgY2xhbmctZGV2ZWwgZGV2aWNlLW1hcHBlci1kZXZlbCB4eiBwYXRjaCIKCiMgRXh0cmFjdCBtYWpvciwgbWlub3IsIGFuZCBwYXRjaCB2ZXJzaW9ucwpJRlM9Jy4nIHJlYWQgLXIgbWFqb3IgbWlub3IgcGF0Y2ggPDw8ICIkZ292ZXJzaW9uIgoKIyBGdW5jdGlvbiB0byBjaGVjayBpZiBjb250YWluZXIgaW1hZ2UgZXhpc3RzIGFuZCBjYW4gYmUgcHVsbGVkCmNoZWNrX2FuZF9wdWxsX2ltYWdlKCkgewogICAgbG9jYWwgdmVyc2lvbj0kMQogICAgbG9jYWwgaW1hZ2U9InJlZ2lzdHJ5LmFjY2Vzcy5yZWRoYXQuY29tL3ViaTkvZ28tdG9vbHNldDoke3ZlcnNpb259IgogICAgZWNobyAiQXR0ZW1wdGluZyB0byBwdWxsIGltYWdlOiAkaW1hZ2UiCiAgICBpZiBwb2RtYW4gcHVsbCAiJGltYWdlIiAyPi9kZXYvbnVsbDsgdGhlbgogICAgICAgIGVjaG8gIlN1Y2Nlc3NmdWxseSBwdWxsZWQgaW1hZ2U6ICRpbWFnZSIKICAgICAgICByZXR1cm4gMAogICAgZWxzZQogICAgICAgIGVjaG8gIkZhaWxlZCB0byBwdWxsIGltYWdlOiAkaW1hZ2UiCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCn0KCiMgVHJ5IHRvIGZpbmQgYSB2YWxpZCBHbyB2ZXJzaW9uIGJ5IHJlZHVjaW5nIHBhdGNoIHZlcnNpb24KZm91bmRfdmVyc2lvbj0iIgpjdXJyZW50X3BhdGNoPSRwYXRjaAoKd2hpbGUgWyAkY3VycmVudF9wYXRjaCAtZ2UgMCBdOyBkbwogICAgdGVzdF92ZXJzaW9uPSIke21ham9yfS4ke21pbm9yfS4ke2N1cnJlbnRfcGF0Y2h9IgogICAgaWYgY2hlY2tfYW5kX3B1bGxfaW1hZ2UgIiR0ZXN0X3ZlcnNpb24iOyB0aGVuCiAgICAgICAgZm91bmRfdmVyc2lvbj0iJHRlc3RfdmVyc2lvbiIKICAgICAgICBicmVhawogICAgZmkKICAgICgoY3VycmVudF9wYXRjaC0tKSkKZG9uZQoKIyBJZiBubyB2ZXJzaW9uIGZvdW5kLCBleGl0IHdpdGggZXJyb3IKaWYgWyAteiAiJGZvdW5kX3ZlcnNpb24iIF07IHRoZW4KICAgIGVjaG8gIkVycm9yOiBDb3VsZCBub3QgZmluZCBhIHB1bGxhYmxlIEdvIHRvb2xzZXQgaW1hZ2UgZm9yIHZlcnNpb24gJHttYWpvcn0uJHttaW5vcn0ueCIKICAgIGV4aXQgMQpmaQoKZWNobyAiVXNpbmcgR28gdmVyc2lvbjogJGZvdW5kX3ZlcnNpb24iCmdvdmVyc2lvbj0iJGZvdW5kX3ZlcnNpb24iCgpta2RpciAtcCAvdG1wL2J1aWxkY3JpbwpwdXNoZCAvdG1wL2J1aWxkY3JpbwojIG1ha2UgdGhlIGJ1aWxkIGVudiBhbmQgYnVpbGQgY3Jpbwpwb2RtYW4gYnVpbGQgLXQgImJ1aWxkY3JpbyIgIC0gPDwgRU9GCkZST00gcmVnaXN0cnkuYWNjZXNzLnJlZGhhdC5jb20vdWJpOS9nby10b29sc2V0OiR7Z292ZXJzaW9ufQoKVVNFUiByb290CgpSVU4gJHtJTlNUQUxMX0NPTU1BTkR9ICYmIFwKICAgIHdnZXQgaHR0cHM6Ly9nby5kZXYvZGwvZ28ke2dvdmVyc2lvbn0ubGludXgtYW1kNjQudGFyLmd6ICYmIHRhciAtQyAvdXNyL2xvY2FsIC14emYgZ28qLnRhci5neiAKV09SS0RJUiAvClJVTiBnaXQgY2xvbmUgaHR0cHM6Ly9naXRodWIuY29tL2NyaS1vL2NyaS1vLmdpdCAtYiByZWxlYXNlLSR7azhzdmVyc2lvbn0KV09SS0RJUiAvY3JpLW8KUlVOIHNlZCAtaSAgJ3MvMjQwLzYwMC8nIGludGVybmFsL29jaS9vY2kuZ28KUlVOIG1ha2UKUlVOIHB3ZApSVU4gbHMgLWwKRU9GCgojIEV4dHJhY3QgdGhlIGNvbXBpbGVkIGNyaW8gYmluYXJ5CmNvbnRhaW5lcl9pZD0kKHBvZG1hbiBjcmVhdGUgYnVpbGRjcmlvKQpwb2RtYW4gY3AgJGNvbnRhaW5lcl9pZDovY3JpLW8vYmluL2NyaW8gLi9jcmlvCnBvZG1hbiBybSAkY29udGFpbmVyX2lkCmVjaG8gIkNSSS1PIGJpbmFyeSBleHRyYWN0ZWQgdG8gLi9jcmlvIgoKIyBWZXJpZnkgdGhlIGJpbmFyeSBleGVjdXRlcyBwcm9wZXJseQplY2hvICJWZXJpZnlpbmcgQ1JJLU8gYmluYXJ5Li4uIgppZiAuL2NyaW8gLS12ZXJzaW9uOyB0aGVuCiAgICBlY2hvICJDUkktTyBiaW5hcnkgdmVyaWZpY2F0aW9uIHN1Y2Nlc3NmdWwiCmVsc2UKICAgIGVjaG8gIkVycm9yOiBDUkktTyBiaW5hcnkgZmFpbGVkIHRvIGV4ZWN1dGUiCiAgICBleGl0IDEKZmkKCm9zdHJlZSBhZG1pbiB1bmxvY2sgLS1ob3RmaXggfHwgdHJ1ZQojIEJhY2t1cCB0aGUgZXhpc3RpbmcgQ1JJLU8gYmluYXJ5IG9ubHkgaWYgbm8gYmFja3VwIGV4aXN0cwpDUklPX0JJTkFSWT0iL3Vzci9iaW4vY3JpbyIKQkFDS1VQX1BBVEg9IiR7Q1JJT19CSU5BUll9LmJhY2t1cCIKCmlmIFsgISAtZiAiJEJBQ0tVUF9QQVRIIiBdOyB0aGVuCiAgICBpZiBbIC1mICIkQ1JJT19CSU5BUlkiIF07IHRoZW4KICAgICAgICBlY2hvICJCYWNraW5nIHVwIGV4aXN0aW5nIENSSS1PIGJpbmFyeSB0byAkQkFDS1VQX1BBVEgiCiAgICAgICAgY3AgLXAgIiRDUklPX0JJTkFSWSIgIiRCQUNLVVBfUEFUSCIKICAgICAgICBlY2hvICJCYWNrdXAgY29tcGxldGVkIgogICAgZWxzZQogICAgICAgIGVjaG8gIldhcm5pbmc6IEV4aXN0aW5nIENSSS1PIGJpbmFyeSBub3QgZm91bmQgYXQgJENSSU9fQklOQVJZIgogICAgZmkKZWxzZQogICAgZWNobyAiQmFja3VwIGFscmVhZHkgZXhpc3RzIGF0ICRCQUNLVVBfUEFUSCwgc2tpcHBpbmcgYmFja3VwIgpmaQoKIyBTdG9wIENSSS1PIHNlcnZpY2UKZWNobyAiU3RvcHBpbmcgQ1JJLU8gc2VydmljZSIKc3lzdGVtY3RsIHN0b3AgY3JpbwoKIyBSZXBsYWNlIHdpdGggdGhlIG5ldyBjb21waWxlZCBiaW5hcnkKZWNobyAiUmVwbGFjaW5nIENSSS1PIGJpbmFyeSB3aXRoIG5ld2x5IGNvbXBpbGVkIHZlcnNpb24iCmNwIC4vY3JpbyAiJENSSU9fQklOQVJZIgpjaG1vZCAreCAiJENSSU9fQklOQVJZIgoKIyBTdGFydCBDUkktTyBzZXJ2aWNlCmVjaG8gIlN0YXJ0aW5nIENSSS1PIHNlcnZpY2UiCnN5c3RlbWN0bCBzdGFydCBjcmlvCgplY2hvICJDUkktTyBiaW5hcnkgcmVwbGFjZWQgc3VjY2Vzc2Z1bGx5IgplY2hvICJUbyByZXN0b3JlIHRoZSBvcmlnaW5hbCBiaW5hcnksIHJ1bjogc3lzdGVtY3RsIHN0b3AgY3JpbyAmJiBjcCAkQkFDS1VQX1BBVEggJENSSU9fQklOQVJZICYmIHN5c3RlbWN0bCBzdGFydCBjcmlvIgpwb3BkCgpleGl0IDAK
    systemd:
      units:
        - name: crio-setup.service
          enabled: true
          contents: |
            [Unit]
            Description=Download and Replace CRI-O Binary
            After=network-online.target dnsmasq.service
            Wants=network-online.target dnsmasq.service
            Before=crio.service

            [Service]
            Type=oneshot
            ExecStart=/usr/local/bin/crio-setup.sh
            RemainAfterExit=yes

            [Install]
            WantedBy=multi-user.target

